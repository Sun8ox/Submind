(()=>{var e={};e.id=909,e.ids=[909],e.modules={415:(e,s,t)=>{"use strict";t.r(s),t.d(s,{patchFetch:()=>R,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>E,workUnitAsyncStorage:()=>g});var r={};t.r(r),t.d(r,{POST:()=>p});var n=t(6559),i=t(8088),a=t(7719),u=t(2190);t(7777);var o=t(4386),c=t(7664),l=t(5693);let d=["video/mp4","video/webm","video/ogg"];async function p(e){try{let s=(await e.cookies).get("Submind.AuthToken"),{success:t,message:r,user:n}=await (0,l.gL)(s);if(!t)return u.NextResponse.json({success:!1,message:r},{status:401});if("CREATOR"!==n.role&&"ADMIN"!==n.role)return u.NextResponse.json({success:!1,message:"You do not have permission to upload videos"},{status:403});let{videoId:i,fileSize:a,contentType:p}=await e.json();if(!a)return u.NextResponse.json({success:!1,message:"File size is required"},{status:400});if(a&&"number"!=typeof a)return u.NextResponse.json({success:!1,message:"File size must be a number"},{status:400});if(a&&a<=0)return u.NextResponse.json({success:!1,message:"File size must be greater than 0"},{status:400});if(a&&a>0x40000000)return u.NextResponse.json({success:!1,message:"File is too big."},{status:400});if(!i)return u.NextResponse.json({success:!1,message:"Video ID is required"},{status:400});let{success:m,message:E}=validateId(i);if(!m)return u.NextResponse.json({success:!1,message:E},{status:400});if(!p)return u.NextResponse.json({success:!1,message:"Content type is required"},{status:400});if(!d.includes(p))return u.NextResponse.json({success:!1,message:"Invalid content type. Supported types are: "+d.join(", ")},{status:400});let g=await (0,o.C5)(i);if(!g)return u.NextResponse.json({success:!1,message:"Video not found"},{status:404});if(g.author!=n.id)return u.NextResponse.json({success:!1,message:"You do not have permission to reupload this video"},{status:403});let f=await (0,c.YB)(i,p,18e3);if(!f)return u.NextResponse.json({success:!1,message:"Failed to get presigned URL"},{status:500});return u.NextResponse.json({success:!0,message:"Presigned URL generated successfully.",presignedUrl:f,videoId:i},{status:200})}catch(e){return console.error("Error validating token:",e),u.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/videos/reupload/route",pathname:"/api/videos/reupload",filename:"route",bundlePath:"app/api/videos/reupload/route"},resolvedPagePath:"/Users/sun8ox/Programming/VisualStudioCode/Websites/submind/src/app/api/videos/reupload/route.js",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:E,workUnitAsyncStorage:g,serverHooks:f}=m;function R(){return(0,a.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:g})}},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},1820:e=>{"use strict";e.exports=require("os")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3496:e=>{"use strict";e.exports=require("http2")},3873:e=>{"use strict";e.exports=require("path")},4386:(e,s,t)=>{"use strict";t.d(s,{C5:()=>n,U3:()=>i,cj:()=>a,fY:()=>u});let r=(0,t(8909).lw)(process.env.DATABASE_URL);async function n(e){let s=await r.query("SELECT * FROM videos.info WHERE id = $1 LIMIT 1",[e]);return 0===s.length?null:s[0]||null}async function i(e){let{name:s,description:t,author:n,subscription_type:i,publicity:a}=e,u=await r.query("INSERT INTO videos.info (name, description, author, subscription, publicity) VALUES ($1, $2, $3, $4, $5) RETURNING *",[s,t,n,i,a]);return 0===u.length?null:u[0]||null}function a(e){return r.query("DELETE FROM videos.info WHERE id = $1",[e])}async function u(e,s=1,t=10,n="Public"){return await r.query("SELECT * FROM videos.info WHERE (subscription = $1 OR subscription = 'Free') AND publicity = $2 ORDER BY created_at DESC LIMIT $3 OFFSET $4",[e,n,t,(s-1)*t])||[]}},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},5693:(e,s,t)=>{"use strict";t.d(s,{gL:()=>i});var r=t(8709),n=t(6536);async function i(e){try{if(!e)return{success:!1,message:"Authentication token is missing. Please log in again."};if(!e.value)return{success:!1,message:"Authentication token is invalid. Please log out and login again."};let{success:s,message:t,userId:i}=await (0,r.k9)(e.value);if(!1===s)return{success:!1,message:t};if(!i)return{success:!1,message:"Authentification token is invalid."};let a=await (0,n.kl)(i);if(!a)return{success:!1,message:"User not found."};if(a.banned)return{success:!1,message:"User is banned."};if(!1===a.verified)return{success:!1,message:"User is not verified."};return{success:!0,user:a}}catch(e){return console.error("Token validation error:",e),{success:!1,message:"Invalid token"}}}},6487:()=>{},6536:(e,s,t)=>{"use strict";t.d(s,{EJ:()=>c,JE:()=>a,LD:()=>d,VJ:()=>o,ht:()=>i,kl:()=>n,lq:()=>l,wg:()=>u});let r=(0,t(8909).lw)(process.env.DATABASE_URL);async function n(e){return(await r.query("SELECT * FROM auth.users WHERE id = $1 LIMIT 1;",[e]))[0]||null}async function i(e){return(await r.query("SELECT * FROM auth.users WHERE email = $1 LIMIT 1;",[e]))[0]||null}async function a(e){return(await r.query("SELECT * FROM auth.users WHERE username = $1 LIMIT 1;",[e]))[0]||null}async function u(e,s){return(await r.query("UPDATE auth.users SET password = $1 WHERE id = $2 RETURNING *;",[s,e]))[0]||null}async function o(e="",s=""){let t=await r.query("SELECT * FROM auth.users WHERE username = $1 OR email = $2 LIMIT 1;",[e,s]);return 0!==t.length&&{usernameExists:t[0].username===e,emailExists:t[0].email===s}}async function c(e,s,t){return(await r.query("INSERT INTO auth.users (username, email, password) VALUES ($1, $2, $3) RETURNING *;",[e,s,t]))[0]||null}async function l(e,s){return(await r.query("INSERT INTO auth.verification (userid, token) VALUES ($1, $2) RETURNING *;",[e,s]))[0]||null}async function d(e,s){let t=await r.query("SELECT * FROM auth.verification WHERE userid = $1 LIMIT 1;",[s]);if(0===t.length)return!1;let n=t[0];return console.log(n),console.log(e),String(n.token).trim()===String(e).trim()&&(await r.query("DELETE FROM auth.verification WHERE userid = $1;",[s]),await r.query("UPDATE auth.users SET verified = true WHERE id = $1;",[s]),!0)}},7075:e=>{"use strict";e.exports=require("node:stream")},7664:(e,s,t)=>{"use strict";t.d(s,{YB:()=>u,TW:()=>a,sx:()=>o});let r=require("@aws-sdk/client-s3");var n=t(9754);let i=new r.S3Client({region:"auto",endpoint:process.env.OBJECT_STORAGE_ENDPOINT,credentials:{accessKeyId:process.env.OBJECT_STORAGE_ACCESS_KEY_ID,secretAccessKey:process.env.OBJECT_STORAGE_SECRET_ACCESS_KEY}});async function a(e,s=18e3){let t=new r.GetObjectCommand({Bucket:process.env.OBJECT_STORAGE_BUCKET_NAME,Key:"video-"+e});return await (0,n.A)(i,t,{expiresIn:s})}async function u(e,s,t=18e3){let a=new r.PutObjectCommand({Bucket:process.env.OBJECT_STORAGE_BUCKET_NAME,Key:"video-"+e,ContentType:s});return await (0,n.A)(i,a,{expiresIn:t})}async function o(e){try{let s=new r.DeleteObjectCommand({Bucket:process.env.OBJECT_STORAGE_BUCKET_NAME,Key:"video-"+e});return await i.send(s),{success:!0,message:"Video deleted successfully"}}catch(e){return console.error("Error deleting video:",e),{success:!1,message:"Failed to delete video"}}}},7777:(e,s,t)=>{},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},8354:e=>{"use strict";e.exports=require("util")},8709:(e,s,t)=>{"use strict";t.d(s,{$u:()=>d,ec:()=>p,ri:()=>m,DY:()=>l,k9:()=>c});var r=t(5663),n=t(6536),i=t(3205),a=t.n(i),u=t(2190);let o=process.env.JWT_SECRET;if(!o)throw Error("JWT_SECRET is not defined");async function c(e){try{let s=a().verify(e,o);if(!s||!s.id)return{success:!1,message:"Invalid token"};return{success:!0,userId:s.id}}catch(e){return console.error("Token validation error:",e),{success:!1,message:"Invalid token"}}}async function l(e){try{let{email:s,username:t,password:i}=e;if(!s||!t||!i)return{success:!1,message:"Email, username and password are required"};let u=(0,n.VJ)(t,s);if(u.usernameExists)return{success:!1,message:"Username already exists"};if(u.emailExists)return{success:!1,message:"Email already exists"};let c=await r.Ay.hash(i,10),l=await (0,n.EJ)(t,s,c);if(!l||!l.id)return{success:!1,message:"Failed to register user"};let d=l.id,p=Math.floor(899999*Math.random()+1e5),m=await (0,n.lq)(d,p);if(!m)return{success:!1,message:"Failed to create verification token"};let E=m.token,g=(console.log(`Sending verification email to ${s} with token ${E}`),{success:!0,message:"Feature not implemented yet, sending to console"});if(!g.success)return{success:!1,message:"Failed to send verification email"};let f=a().sign({id:d},o,{expiresIn:"7d"});if(!f)return{success:!1,message:"Failed to create authentication token"};return{success:!0,message:"Registration successful. "+g.message,token:f}}catch(e){return console.error("Registration error:",e),{success:!1,message:"Registration failed"}}}async function d(e){try{let{email:s,username:t,password:i}=e;if(!s&&!t)return{success:!1,message:"Email or username is required"};let u=t?await (0,n.JE)(t):await (0,n.ht)(s);if(!u)return{success:!1,message:"User not found"};if(!await r.Ay.compare(i,u.password))return{success:!1,message:"Invalid username or password"};let c=a().sign({id:u.id},o,{expiresIn:"7d"});return{success:!0,message:"Authentication successful",token:c}}catch(e){return console.error("Authentication error:",e),{success:!1,message:"Authentication failed"}}}async function p(e,s,t){try{let i=await (0,n.kl)(e);if(!i)return{success:!1,message:"User not found"};if(!await r.Ay.compare(s,i.password))return{success:!1,message:"Old password is incorrect"};if(await r.Ay.compare(t,i.password))return{success:!1,message:"New password cannot be the same as the old password"};let a=await r.Ay.hash(t,10);if(!await (0,n.wg)(e,a))return{success:!1,message:"Failed to update password"};return{success:!0,message:"Password changed successfully"}}catch(e){return console.error("Error changing password:",e),{success:!1,message:"Failed to change password"}}}function m(e){let s=u.NextResponse.redirect(new URL("/",e.url));return s.cookies.set("Submind.AuthToken","",{maxAge:-1}),s}},9021:e=>{"use strict";e.exports=require("fs")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[719,660,754],()=>t(415));module.exports=r})();